<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Moon Phase Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        .moon-phase { transition: all 0.3s ease; cursor: pointer; }
        .moon-phase:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(255,255,255,0.12); }
        .moon-icon {
            width: 80px; height: 80px;
            background: radial-gradient(circle at 30% 40%, #e0e0e0 0%, #a0a0a0 100%);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 14px rgba(255,255,255,0.08) inset;
        }
        .moon-shadow {
            position: absolute;
            background: #0f0f23;
            border-radius: 50%;
            transition: all 0.25s ease;
            pointer-events: none;
        }
        .shine {
            position: absolute;
            width: 18px; height: 18px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            filter: blur(4px);
            pointer-events: none;
        }
        .star {
            position: absolute;
            width: 2px; height: 2px;
            background: white; border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        @keyframes twinkle { 0%,100%{opacity:.3} 50%{opacity:1} }
        .glow { box-shadow: 0 0 40px rgba(255,255,255,0.06); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-4xl w-full mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-blue-200 via-purple-200 to-pink-200 bg-clip-text text-transparent mb-4">
                Moon Phase Tracker
            </h1>
            <p class="text-gray-300 text-lg">Follow the lunar cycle and plan accordingly</p>
        </div>

        <!-- Today's Moon Phase -->
        <div class="bg-gray-900/50 backdrop-blur-sm rounded-3xl p-8 mb-8 glow">
            <div class="text-center">
                <h2 class="text-2xl font-semibold mb-6">Today's Moon Phase</h2>
                <div class="flex flex-col items-center">
                    <div id="today-moon" class="moon-phase mb-4 relative">
                        <div class="moon-icon"></div>
                    </div>
                    <div id="today-info" class="space-y-2">
                        <div class="text-xl font-medium" id="phase-name">Loading…</div>
                        <div class="text-gray-300" id="today-date"></div>
                        <div class="text-sm text-gray-400" id="illumination"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Next 7 Days Section -->
        <div class="bg-gray-900/50 backdrop-blur-sm rounded-3xl p-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold mb-4 md:mb-0">Next 7 Days</h2>
                <button id="toggle-next-days" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-full font-medium transition-colors">
                    Show Next 7 Days
                </button>
            </div>

            <div id="next-days-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4 hidden">
                <!-- Moon phases for next 7 days will be generated here -->
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-8 text-center text-gray-400 text-sm">
            <p>Moon phase data fetched from FarmSense (fallback to local calculation if the API fails).</p>
        </div>
    </div>

    <script>
    /**
     * Moon Phase Tracker
     * - Fetches real-time moon phase data from FarmSense API (https://api.farmsense.net/v1/moonphases/?d=TIMESTAMP)
     * - If the API fails, falls back to a local approximation algorithm
     * - Updates the main moon icon and a "next 7 days" view
     *
     * Notes:
     * - FarmSense expects UNIX timestamp (seconds) as 'd' param.
     * - The API returns an array; we take element 0 for a single date.
     */
    class MoonPhaseTracker {
        constructor() {
            this.currentDate = new Date();
            this.phaseNames = {
                0: 'New Moon',
                1: 'Waxing Crescent',
                2: 'First Quarter',
                3: 'Waxing Gibbous',
                4: 'Full Moon',
                5: 'Waning Gibbous',
                6: 'Last Quarter',
                7: 'Waning Crescent'
            };
            this.initialize();
            this.createStars();
        }

        async initialize() {
            // Fill today's date immediately
            document.getElementById('today-date').textContent = this.currentDate.toLocaleDateString();
            // Attempt to fetch & display today phase
            await this.updateTodayPhase();
            // Setup UI
            this.setupEventListeners();
        }

        setupEventListeners() {
            const toggleBtn = document.getElementById('toggle-next-days');
            toggleBtn.addEventListener('click', async () => {
                const container = document.getElementById('next-days-container');
                if (container.classList.contains('hidden')) {
                    toggleBtn.disabled = true;
                    toggleBtn.textContent = 'Loading…';
                    try {
                        await this.showNext7Days();
                        container.classList.remove('hidden');
                        toggleBtn.textContent = 'Hide Next 7 Days';
                    } catch (e) {
                        console.error('Failed to show next 7 days:', e);
                        toggleBtn.textContent = 'Show Next 7 Days';
                        alert('Could not fetch next 7 days. Check console for details.');
                    } finally {
                        toggleBtn.disabled = false;
                    }
                } else {
                    container.classList.add('hidden');
                    toggleBtn.textContent = 'Show Next 7 Days';
                }
            });
        }

        async fetchMoonData(date) {
            // FarmSense expects UNIX timestamp (seconds)
            const ts = Math.floor(date.getTime() / 1000);
            const url = `https://api.farmsense.net/v1/moonphases/?d=${ts}`;

            try {
                const resp = await fetch(url, { method: 'GET' });
                if (!resp.ok) throw new Error('Network response not OK: ' + resp.status);
                const data = await resp.json();
                // Expect data array; take first element
                if (!Array.isArray(data) || data.length === 0) throw new Error('Unexpected API response');
                const obj = data[0];
                // Standardize keys: Phase (string), Illumination (string/number), Age (maybe)
                const phaseName = obj.Phase || obj.phase || 'Unknown';
                let illum = obj.Illumination ?? obj.illumination ?? obj.IlluminationPercent ?? null;
                if (illum === null || illum === undefined) {
                    // if no illumination, try to derive from 'Age' or fallback
                    illum = null;
                }
                // Convert to number safely
                const illumination = illum === null ? null : Number(illum);
                return {
                    phaseName,
                    illumination,
                    raw: obj
                };
            } catch (err) {
                console.warn('FarmSense API failed, falling back to local calc. Error:', err);
                // Throw so caller can choose to fallback; or return null to indicate failure
                throw err;
            }
        }

        // Local fallback algorithm (simpler, approximate). Returns similar shaped object.
        localMoonCalc(date) {
            // Using a simple known-new-moon + synodic-month approach (approximation).
            // This is the old fallback you had improved a bit.
            const knownNewMoon = new Date('2000-01-06T18:14:00Z'); // a reference new moon (approx)
            const lunarCycle = 29.530588853; // days
            const daysSince = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
            const phase = (daysSince % lunarCycle + lunarCycle) % lunarCycle; // 0..lunarCycle
            const fraction = phase / lunarCycle; // 0..1
            const phaseNum = Math.floor(fraction * 8) % 8;
            // Illumination approximation
            const illum = Math.round((1 - Math.abs(0.5 - fraction) * 2) * 100);
            const phaseName = this.phaseNames[phaseNum] || 'Unknown';
            return {
                phaseName,
                illumination: illum,
                local: true
            };
        }

        // Map phase name string to index 0..7
        phaseNameToIndex(phaseName) {
            if (!phaseName || typeof phaseName !== 'string') return 0;
            const s = phaseName.toLowerCase();
            if (s.includes('new')) return 0;
            if (s.includes('waxing crescent')) return 1;
            if (s.includes('first') || s.includes('first quarter') || s.includes('quarter') && s.includes('first')) return 2;
            if (s.includes('waxing gibbous')) return 3;
            if (s.includes('full')) return 4;
            if (s.includes('waning gibbous')) return 5;
            if (s.includes('last') || s.includes('third') || s.includes('last quarter') || s.includes('third quarter')) return 6;
            if (s.includes('waning crescent')) return 7;
            // If the API returns simple strings like "Waxing" / "Waning", do a rough mapping by keywords
            if (s.includes('waxing')) {
                // decide between crescent/gibbous by containing 'crescent' or 'gibbous'
                if (s.includes('crescent')) return 1;
                if (s.includes('gibbous')) return 3;
                return 2;
            }
            if (s.includes('waning')) {
                if (s.includes('crescent')) return 7;
                if (s.includes('gibbous')) return 5;
                return 6;
            }
            return 0; // fallback to new moon
        }

        // Update the visible moon icon for a given element id.
        updateMoonIcon(elementId, phaseName, illumination) {
            const container = document.getElementById(elementId);
            if (!container) return;
            // find or create the inner moon-icon element
            let moonEl = container;
            if (!moonEl.classList.contains('moon-icon')) {
                moonEl = container.querySelector('.moon-icon');
                if (!moonEl) {
                    moonEl = document.createElement('div');
                    moonEl.className = 'moon-icon';
                    container.appendChild(moonEl);
                }
            }

            // Remove old shadow(s) and shine(s)
            moonEl.querySelectorAll('.moon-shadow').forEach(e => e.remove());
            moonEl.querySelectorAll('.shine').forEach(e => e.remove());

            // Normalize illumination
            const illumNum = (illumination === null || illumination === undefined || isNaN(illumination))
                ? 0 : Math.max(0, Math.min(100, Number(illumination)));

            // Convert phase name to index 0..7 for styling decisions
            const pIdx = this.phaseNameToIndex(phaseName);
            const size = 80; // must match CSS .moon-icon
            // Decide the shadow geometry by phase index and illumination
            // We'll create an overlapping dark circle to represent the shadowed part.
            if (pIdx === 4) {
                // Full moon: no shadow
            } else if (pIdx === 0) {
                // New moon: fully dark - create a full black circle on top
                const s = document.createElement('div');
                s.className = 'moon-shadow';
                s.style.cssText = `width:${size}px;height:${size}px;left:0;top:0;`;
                moonEl.appendChild(s);
            } else {
                // For crescents/gibbous/quarters, compute a shadow ellipse offset
                // We'll map illumination to shadow width: more illumination => smaller shadow width (more lit)
                // shadowWidthPercent ranges from 0 (no shadow/full moon) to 100 (full shadow/new moon)
                // Convert illumination -> shadow fraction:
                const shadowFraction = 1 - (illumNum / 100); // 0..1
                // We'll clamp and map to a reasonable width for the overlapping shadow
                const shadowWidth = Math.max(6, Math.round(size * (0.15 + shadowFraction * 0.85))); // px
                // positionLeft depends on waxing/waning and crescent/gibbous
                let left = 0;
                // For wax/waning detection using phaseName
                const isWaxing = (String(phaseName).toLowerCase().includes('wax') || [1,2,3].includes(pIdx));
                // If waxing: shadow sits to the left (so lit on right). If waning: shadow sits to the right (lit on left)
                if (isWaxing) {
                    left = size - shadowWidth;
                } else {
                    left = 0;
                }
                // For quarter phases we make a half-shadow
                if (pIdx === 2 || pIdx === 6) {
                    // half-circle shadow: width = size/2
                    const s = document.createElement('div');
                    s.className = 'moon-shadow';
                    s.style.cssText = `width:${size/2}px;height:${size}px;left:${left}px;top:0;`;
                    moonEl.appendChild(s);
                } else {
                    // create a vertical oval that roughly produces crescent/gibbous impression
                    const s = document.createElement('div');
                    s.className = 'moon-shadow';
                    // For more natural look, make shadow height slightly more than moon to create nice curve
                    s.style.cssText = `width:${shadowWidth}px;height:${size}px;left:${left}px;top:0;`;
                    moonEl.appendChild(s);
                }
            }

            // Add a subtle shine if not new moon
            if (!String(phaseName).toLowerCase().includes('new')) {
                const shine = document.createElement('div');
                shine.className = 'shine';
                // position the shine to the lit side
                const isLitRight = (this.phaseNameToIndex(phaseName) > 0 && this.phaseNameToIndex(phaseName) < 4); // waxing -> lit right
                shine.style.top = '16px';
                shine.style[isLitRight ? 'right' : 'left'] = '16px';
                moonEl.appendChild(shine);
            }
        }

        async updateTodayPhase() {
            const phaseEl = document.getElementById('phase-name');
            const illumEl = document.getElementById('illumination');
            phaseEl.textContent = 'Loading…';
            illumEl.textContent = '';

            try {
                const apiResult = await this.fetchMoonData(this.currentDate);
                const phaseName = apiResult.phaseName || 'Unknown';
                const illumination = apiResult.illumination !== null ? Math.round(apiResult.illumination) : null;

                phaseEl.textContent = phaseName;
                illumEl.textContent = (illumination === null) ? '' : `${illumination}% illuminated`;
                this.updateMoonIcon('today-moon', phaseName, illumination);
            } catch (err) {
                // fallback
                const fallback = this.localMoonCalc(this.currentDate);
                phaseEl.textContent = fallback.phaseName + ' (approx)';
                illumEl.textContent = `${fallback.illumination}% illuminated (approx)`;
                this.updateMoonIcon('today-moon', fallback.phaseName, fallback.illumination);
            }
        }

        async showNext7Days() {
            const container = document.getElementById('next-days-container');
            container.innerHTML = ''; // clear
            // Build an array of dates
            const dates = [];
            for (let i = 1; i <= 7; i++) {
                const d = new Date(this.currentDate);
                d.setDate(this.currentDate.getDate() + i);
                dates.push(d);
            }

            // Try to query API in parallel with Promise.allSettled
            const fetchPromises = dates.map(d => this.fetchMoonData(d).then(res => ({ok: true, res})).catch(e => ({ok: false, err: e})));
            const results = await Promise.all(fetchPromises);

            for (let i = 0; i < dates.length; i++) {
                const futureDate = dates[i];
                let phaseName, illumination;
                if (results[i].ok) {
                    phaseName = results[i].res.phaseName || 'Unknown';
                    illumination = results[i].res.illumination !== null ? Math.round(results[i].res.illumination) : null;
                } else {
                    // fallback for this date
                    const fallback = this.localMoonCalc(futureDate);
                    phaseName = fallback.phaseName + ' (approx)';
                    illumination = fallback.illumination;
                }

                const dayElement = document.createElement('div');
                dayElement.className = 'text-center moon-phase p-4 rounded-2xl bg-gray-800/50 hover:bg-gray-700/50 transition-colors';
                dayElement.innerHTML = `
                    <div class="text-sm text-gray-300 mb-2">${futureDate.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    <div class="text-xs text-gray-400 mb-3">${futureDate.getDate()}/${futureDate.getMonth() + 1}</div>
                    <div class="flex justify-center mb-3">
                        <div class="moon-icon relative" id="moon-${i+1}"></div>
                    </div>
                    <div class="text-sm font-medium truncate" title="${phaseName}">${phaseName}</div>
                    <div class="text-xs text-gray-400 mt-1">${illumination !== null ? illumination + '%' : ''}</div>
                `;
                container.appendChild(dayElement);
                // Update moon icon visually
                this.updateMoonIcon(`moon-${i+1}`, phaseName, illumination);
            }
        }

        createStars() {
            const body = document.body;
            // only create once: if stars already present skip
            if (document.querySelectorAll('.star').length > 0) return;
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                // spread inside viewport area (using vw/vh)
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.animationDelay = (Math.random() * 3) + 's';
                star.style.opacity = (Math.random() * 0.7 + 0.3).toString();
                body.appendChild(star);
            }
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        new MoonPhaseTracker();
    });
    </script>
</body>
</html>
